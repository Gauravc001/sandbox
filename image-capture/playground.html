<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Image Capture Playground</title>
<style>
  body { margin: 0 auto; }
  #dashboard { position: fixed; width: 100%; background: white; z-index: 1; padding: 8px; }
  #shots { position: absolute; top: 200px; padding: 8px }
  video { float: right; box-shadow: 0 0 0px 1px black; margin-right: 16px; }
  canvas { float: left; clear: right; }
  pre { clear: both; padding: 12px 0; }
  input { margin: 12px }
  input:after { content: attr(data-label); display: block; position: fixed; width: 129px; margin-top: -18px; text-align: center; }
  input[disabled] { opacity: .5 }
}
</style>

<div id="dashboard">
  <button id="getCapabilities">getCapabilities</button>
  <button id="getSettings">getSettings</button>
  <button id="grabFrameButton">grabFrame</button>
  <button id="takePhotoButton">takePhoto</button>
  <button id="grabFrameAndTakePhotoButton">grabFrame & takePhoto</button>
  <video autoplay width="160" height="90"></video>
  <br/><br/><br/>
  <div id="controls"></div>
</div>
<div id="shots"></div>

<script>
var imageCapture;
var constraints = {
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 }
  }
};
navigator.mediaDevices.getUserMedia(constraints)
.then(mediaStream => {
  imageCapture = new ImageCapture(mediaStream.getVideoTracks()[0]);
  document.querySelector('video').srcObject = mediaStream;
  // Remove timeout when crbug.com/711524 is fixed.
  setTimeout(initControls, 500);
})
.catch(error => {
  console.log(error);
});

function initControls() {
  document.querySelector('#controls').innerHTML = '';
  let capabilities = imageCapture.track.getCapabilities();
  let settings = imageCapture.track.getSettings();
  for (let capabilityName in capabilities) {
    let capability = capabilities[capabilityName];
    if (capability.toString() === '[object MediaSettingsRange]') {
      let value = settings[capabilityName];
      addInputRange(capabilityName, value, capability);
    }
  }
}

function addInputRange(capabilityName, value, range) {
  let input = document.createElement('input');
  input.type = 'range';
  input.min = range.min;
  input.max = range.max;
  input.step = range.step;
  input.value = value;
  input.oninput = function(event) {
    let options = {};
    options[capabilityName] = event.target.value;
    imageCapture.track.applyConstraints({advanced: [ options ]});
  }
  input.dataset['label'] = capabilityName;
  document.querySelector('#controls').appendChild(input);
}

document.querySelector('#getCapabilities').addEventListener('click', getCapabilities);
document.querySelector('#getSettings').addEventListener('click', getSettings);
document.querySelector('#grabFrameButton').addEventListener('click', grabFrame);
document.querySelector('#takePhotoButton').addEventListener('click', takePhoto);
document.querySelector('#grabFrameAndTakePhotoButton').addEventListener('click', grabFrameAndTakePhoto);

function getCapabilities() {
  let capabilities = imageCapture.track.getCapabilities();
  let pre = document.createElement('pre');
  for (let capabilityName in capabilities) {
    pre.innerText += `${capabilityName}: `;
    let capability = capabilities[capabilityName];
    if (capability.toString() === '[object MediaSettingsRange]') {
      pre.innerText += `{ min: ${capability.min}, max: ${capability.max}, step: ${capability.step} }\r\n`;
    } else {
      pre.innerText += JSON.stringify(capability) + '\r\n';
    }
  }
  document.querySelector('#shots').appendChild(pre);
}

function getSettings() {
  let settings = imageCapture.track.getSettings();
  let pre = document.createElement('pre');
  pre.innerText += JSON.stringify(settings, 0, 2);
  document.querySelector('#shots').appendChild(pre);
}

function grabFrame() {
  return imageCapture.grabFrame()
  .then(imageBitmap => appendCanvas(imageBitmap))
  .catch(error => {
    console.log(error);
  });
}

function takePhoto() {
  return imageCapture.takePhoto()
  .then(blob => createImageBitmap(blob))
  .then(imageBitmap => appendCanvas(imageBitmap))
  .catch(error => {
    console.log(error);
  });
}

function grabFrameAndTakePhoto() {
  return grabFrame()
  .then(_ => takePhoto());
}

function appendCanvas(imageBitmap) {
  let canvas = document.createElement('canvas');
  canvas.width = imageBitmap.width;
  canvas.height = imageBitmap.height;
  canvas.style.height = '180';
  
  let context = canvas.getContext('2d');
  context.drawImage(imageBitmap, 0, 0, imageBitmap.width, imageBitmap.height);
  context.font = canvas.height / 12 + 'px Cousine';
  context.fillStyle = 'deeppink';
  context.textBaseline = 'top';
  context.fillText(`${canvas.width}x${canvas.height}`, 0, 0);
  document.querySelector('#shots').appendChild(canvas);
}

</script>
