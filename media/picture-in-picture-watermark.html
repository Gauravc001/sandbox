<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  div {
    margin-bottom: 24px;
  }
</style>
<body>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
    <path id="path" d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/>
  </svg>
  <video id="video" autoplay muted src="https://storage.googleapis.com/media-session/caminandes/short.mp4"></video>
  <input id="fileInput" type="file" accept="image/*">
</body>
<script>
  fileInput.addEventListener('change', async function() {
    if (document.pictureInPictureElement) 
      await document.exitPictureInPicture();

    if (!fileInput.files.length)
      return;

    const watermarkImage = await getImage(fileInput.files[0]);

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    drawVideoWithWatermark(canvas, video, watermarkImage);

    const pipVideo = document.createElement('video');
    pipVideo.muted = true;
    pipVideo.srcObject = canvas.captureStream(60 /* fps */);
    await pipVideo.play();
    pipVideo.requestPictureInPicture();
  });

  function drawVideoWithWatermark(canvas, video, watermarkImage) {
    setTimeout(function() { drawVideoWithWatermark(canvas, video, watermarkImage); }, 1000 / 60);

    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    context.drawImage(watermarkImage, canvas.width - 128, canvas.height - 128, 128, 128);
  }

  function getImage(file) {
    return new Promise(resolve => {
      var reader = new FileReader();
      var img = new Image();
      img.onload = _ => {
        resolve(img);
      }
      reader.onloadend = _ => {
        img.src = reader.result;
      }
      reader.readAsDataURL(file);
    });
  }
</script>
