<html>
  <title>background fetch video</title>
  <meta name="viewport" content="width=device-width">
  <style> body { margin: 0 auto; } pre { padding: 8px } </style>
  <video controls id="video" width="640" height="360" preload="none"
      src='https://storage.googleapis.com/fbeaufort-test/sample.webm'
      poster="https://storage.googleapis.com/fbeaufort-test/poster.jpg"></video>
  <br/>
  <br/>
  <button id="buttonServiceWorker" disabled>Make available offline (background)</button>
  <button id="buttonCache" disabled>Make available offline (foreground)</button>
  <pre id="pre"></pre>
  <script>

const channel = new BroadcastChannel('channel');
channel.onmessage = function(e) {
  log(e.data.status);
};

if ('serviceWorker' in navigator) {
  buttonCache.disabled = false;
  buttonCache.addEventListener('click', onButtonCacheClick);
  registerServiceWorker();
} else {
  log('Browser doesn\'t support service workers');
}

async function registerServiceWorker() {
  try {
    const registration = await navigator.serviceWorker.register('sw.js');
    log('Service worker registered successfully');
    if ('backgroundFetch' in registration) {
      buttonServiceWorker.disabled = false;
      buttonServiceWorker.addEventListener('click', onButtonServiceWorkerClick);
    }
  } catch(error) {
    log('Error registering service worker', error);
  }
}

async function onButtonServiceWorkerClick() {
  log('Downloading in background...');
  const registration = await navigator.serviceWorker.ready;
  const requests = [video.src];
  const tag = video.src; // Because it's just easier...
  const bgFetchJob = await registration.backgroundFetch.fetch(tag, requests);
}

async function onButtonCacheClick() {
  log('Downloading in foreground...');
  const cache = await caches.open('video-cache');
  await cache.add(video.src);
  log('Downloaded!');
}


/* util */

function log(text) {
  pre.textContent += text + '\r\n';
}
  </script>
</html>
