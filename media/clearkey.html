<video crossorigin autoplay controls id="video" width="640" height="360"></video>
<select id="select">
  <option value="https://storage.googleapis.com/fbeaufort-test/sample-video-encrypted-with-no-clear-lead.webm">VP9 - No Clear Lead</option>
  <option value="https://storage.googleapis.com/fbeaufort-test/sample-video-encrypted-with-clear-lead.webm">VP9 - Clear Lead of 10s</option>
  <option value="https://storage.googleapis.com/fbeaufort-test/sample-video-encrypted-with-no-clear-lead.mp4">H264 - No Clear Lead</option>
  <option value="https://storage.googleapis.com/fbeaufort-test/sample-video-encrypted-with-clear-lead.mp4">H264 - Clear Lead of 10s</option>
</select>
<script>

  const KEY = new Uint8Array([
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
  ]);

  video.addEventListener('encrypted', function(event) {
    console.log('encrypted event:', event);

    const session = video.mediaKeys.createSession();
    session.addEventListener('message', handleSessionMessage);

    session.generateRequest(event.initDataType, event.initData);
  });

  (async _ => {
    console.log('RMKSA');

    const config = [{
      initDataTypes: ['cenc', 'webm'],
      videoCapabilities: [
        { contentType: 'video/mp4; codecs="avc1.4d401f"' },
        { contentType: 'video/webm; codecs="vp9"' }
      ]
    }];
    const keySystemAccess = await navigator.requestMediaKeySystemAccess('org.w3.clearkey', config);
    const mediaKeys = await keySystemAccess.createMediaKeys();
    await video.setMediaKeys(mediaKeys);
    console.log('Media keys set up');
  })();

  async function handleSessionMessage(event) {
    console.log('message event: ', event);

    const license = await fetch('fake-license.html', { body: event.message });

    const session = event.target;
    await session.update(license);
    console.log('Session updated');
  }


  /* Utils */
  
  // This takes the place of a license server.
  async function fetch(fakeUrl, init) {
    return new Promise((resolve, reject) => { setTimeout(_ => {

        // Parse the clearkey license request.
        const licenseRequest = JSON.parse(new TextDecoder().decode(init.body));
        console.log('License request:', licenseRequest);
  
        // A JSON Web Key (JWK) Set contains the representation of the symmetric key
        // to be used for decryption: https://tools.ietf.org/html/rfc7517
        const jwk = {
          keys: [{
            kty: 'oct', /* key type */
            kid: licenseRequest.kids[0], /* base64url encoding of the octet sequence containing the key ID value */
            k: toBase64(KEY) /* base64url encoding of the octet sequence containing the symmetric key value */
          }]
        };
        console.log('license response:', jwk);
        const licenseResponse = new TextEncoder().encode(JSON.stringify(jwk));

        resolve(licenseResponse);

      }, 2000);
    });
  }

  // Convert Uint8Array into base64 using base64url alphabet, without padding.
  function toBase64(u8arr) {
    // See https://en.wikipedia.org/wiki/Base64#URL_applications
    return btoa(String.fromCharCode.apply(null, u8arr)).
      replace(/\+/g, '-').replace(/\//g, '_').replace(/=*$/, '');
  }

  select.addEventListener('change', function(event) {
    video.src = select.options[select.selectedIndex].value;
  });

  // Play first video at load.
  select.selectedIndex = 0;
  video.src = select.options[select.selectedIndex].value;
  
</script>

